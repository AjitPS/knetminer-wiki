# Deploying Knetminer with Docker


## Introduction

Knetminer can be deployed in a quick and simple way, using the Docker container platform. In 
the simplest case, you just need to install the Docker environment and get our
[Knetminer image from DockerHub][10]. For more advanced uses, our image can be used with 
host-provided configurations. Additionally, you can customise our [image definitions](TODO). 
Details are explained in the follow.  

[10]: https://cloud.docker.com/u/knetminer/repository/docker/knetminer/knetminer


## The Knetminer Docker architecture

### Docker images
As usually, the main contained is defined by the [Dockerfile image file][20]. This builds 
what is needed to deploy our web applications (two .war files) on our Java web server 
(Tomcat).

This application image extends the [Dockerfile-base image][30]. This prepares a container 
with all the Maven-reachable dependencies downloaded and put in place into the container file 
system.

Finally, the base image depends on [Dockerfile-bare image][40]. This pulls up the 
[Andre's Tomcat container][50], which is eseentially a Debian with Java and Tomcat installed, 
and additionally deploys third-party dependencies that are needed by Knetminer (eg, Maven, 
the Node.js package manager, NPM).

The motivation for distributing the build of the final container into three different images 
is that this makes the development quicker. For instance, if one need just to change a web 
application page, rebuilding the main container only achieve that the changes are moved 
forward, without having to rebuild any other dependencies.

### Dataset-independent container
The Dockerfile container performs several application building operations at runtime, once 
the image has been created. Namely, 
  * It places configuration files on a fixed directory on the container filesystem.
  * It builds a reference [server application][60] (ie, the Knetminer web service API) and 
  places it into the Tomcat installation on the container.
  * It prepares links for the [client application][60] (ie, front-end).
  * Creates some optional settings (eg, makes the Tomcat manager application accessible).
  
The Docker image building script **doesn't** build the client WAR at the Docker image 
building time, since the exact contents for this depend on the specific dataset that you want 
serve with Knetminer.

This is the job of the [runtime helper][70]. This is set as [container entry point][80] and 
uses Maven to build the Knetminer client at run time, configuring it with a user-defined 
configuration (which is usually put in some host directory and passed to the container as 
mapped volume).

That file does the following:
  * It takes dataset (ie, specie)-specific files (the instance files) and uses them to 
  prepare a server configuration (eg, to populate `data-sources.xml`, to provide 
  `SemanticMotifs.txt`), by etiher making copies to a config directory, or instantiating 
  template files using Maven settings (which are defined in the instance directory as well). 
  These instance files are usually stored in some directory under the
  [species/ directory][90], under the Knetminer codebase.
  * Similarly, it takes dataset-specific client files, places them on a build directory and 
  uses them to build a client that is specific for the dataset being run.
  * Runs the Tomcat server in the container, which sees the created configuration and the 
  built client WAR. 

Configuration files and the build location can be mapped to an host location, as usually, via Docker volumes.
This is done by the [docker-run.sh script][100]. (TODO: review)
  

[20]: /Rothamsted/knetminer/blob/201904_new_docker/common/quickstart/Dockerfile
[30]: /Rothamsted/knetminer/blob/201904_new_docker/common/quickstart/Dockerfile-base
[40]: /Rothamsted/knetminer/blob/201904_new_docker/common/quickstart/Dockerfile-bare
[50]: https://hub.docker.com/r/andreptb/tomcat
[60]: /Rothamsted/knetminer/tree/master/common/aratiny
[70]: /Rothamsted/knetminer/blob/201904_new_docker/common/quickstart/runtime-helper.sh
[80]: https://aws.amazon.com/blogs/opensource/demystifying-entrypoint-cmd-docker
[90]: /Rothamsted/knetminer/tree/201904_new_docker/species
[100]: /Rothamsted/knetminer/blob/201904_new_docker/common/quickstart/docker-run.sh
